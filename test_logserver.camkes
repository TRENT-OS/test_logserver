/*
 * Copyright (C) 2020-2021, HENSOLDT Cyber GmbH
 */

import <std_connector.camkes>;

// Clients
import "components/log_clients/FileReaderWriter/FileReaderWriter.camkes";
import "components/log_clients/LogFileReader/LogFileReader.camkes";
import "components/log_clients/LogsAllLevels/LogsAllLevels.camkes";

// Server
import "components/LogServer/LogServer.camkes";

#include "system_config.h"

#include "RamDisk/RamDisk.camkes"
RamDisk_COMPONENT_DEFINE(RamDisk)

#include "TimeServer/camkes/TimeServer.camkes"
TimeServer_COMPONENT_DEFINE(TimeServer)

assembly {
    composition {
        //----------------------------------------------------------------------
        // LogServer
        //----------------------------------------------------------------------
        component   LogServer              logServer;

        component   RamDisk                ramDisk;

        RamDisk_INSTANCE_CONNECT_CLIENT(
          ramDisk,
          logServer.storage_rpc,
          logServer.storage_port)

        //----------------------------------------------------------------------
        // TimeServer
        //----------------------------------------------------------------------
        component TimeServer timeServer;

        TimeServer_INSTANCE_CONNECT_CLIENTS(
            timeServer,
            logServer.timeServer_rpc, logServer.timeServer_notify
        )

        //----------------------------------------------------------------------
        // FileReaderWriter Client
        //----------------------------------------------------------------------
        component   FileReaderWriter       fileReaderWriter;

        connection  seL4RPCCall            conn_rpc_logServer2fileReaderWriter(     from fileReaderWriter.log_server_interface,      to logServer.log_server_interface);

        component   RamDisk                ramDisk_frw;

        RamDisk_INSTANCE_CONNECT_CLIENT(
            ramDisk_frw,
            fileReaderWriter.storage_rpc,
            fileReaderWriter.storage_port)

        //----------------------------------------------------------------------
        // LogFileReader Client
        //----------------------------------------------------------------------
        component   LogFileReader          logFileReader;

        connection  seL4RPCCall            conn_rpc_logServer2logFileReader(        from logFileReader.log_server_interface,         to logServer.log_server_interface);

        //----------------------------------------------------------------------
        // Test Apps
        //----------------------------------------------------------------------

        component LogsAllLevels     app_lvl_none;
        component LogsAllLevels     app_lvl_assert;
        component LogsAllLevels     app_lvl_fatal;
        component LogsAllLevels     app_lvl_error;
        component LogsAllLevels     app_lvl_warning;
        component LogsAllLevels     app_lvl_info;
        component LogsAllLevels     app_lvl_debug;
        component LogsAllLevels     app_lvl_trace;
        component LogsAllLevels     app_lvl_custom;
        component LogsAllLevels     app_lvl_max;

        component LogsAllLevels     app_no_filters;

        component LogsAllLevels     app_cl_filter_none;
        component LogsAllLevels     app_cl_filter_assert;
        component LogsAllLevels     app_cl_filter_fatal;
        component LogsAllLevels     app_cl_filter_error;
        component LogsAllLevels     app_cl_filter_warning;
        component LogsAllLevels     app_cl_filter_info;
        component LogsAllLevels     app_cl_filter_debug;
        component LogsAllLevels     app_cl_filter_trace;
        component LogsAllLevels     app_cl_filter_custom;


        // seL4RPCCall
        connection  seL4RPCCall         conn_rpc_logServer2app_lvl_none(   from app_lvl_none.log_server_interface,    to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_lvl_assert( from app_lvl_assert.log_server_interface,  to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_lvl_fatal(  from app_lvl_fatal.log_server_interface,   to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_lvl_error(  from app_lvl_error.log_server_interface,   to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_lvl_warning(from app_lvl_warning.log_server_interface, to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_lvl_info(   from app_lvl_info.log_server_interface,    to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_lvl_debug(  from app_lvl_debug.log_server_interface,   to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_lvl_trace(  from app_lvl_trace.log_server_interface,   to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_lvl_custom( from app_lvl_custom.log_server_interface,  to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_lvl_max(    from app_lvl_max.log_server_interface,     to logServer.log_server_interface);

        connection  seL4RPCCall         conn_rpc_logServer2app_no_filters( from app_no_filters.log_server_interface,  to logServer.log_server_interface);

        connection  seL4RPCCall         conn_rpc_logServer2app_cl_filter_none(   from app_cl_filter_none.log_server_interface,    to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_cl_filter_assert( from app_cl_filter_assert.log_server_interface,  to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_cl_filter_fatal(  from app_cl_filter_fatal.log_server_interface,   to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_cl_filter_error(  from app_cl_filter_error.log_server_interface,   to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_cl_filter_warning(from app_cl_filter_warning.log_server_interface, to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_cl_filter_info(   from app_cl_filter_info.log_server_interface,    to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_cl_filter_debug(  from app_cl_filter_debug.log_server_interface,   to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_cl_filter_trace(  from app_cl_filter_trace.log_server_interface,   to logServer.log_server_interface);
        connection  seL4RPCCall         conn_rpc_logServer2app_cl_filter_custom( from app_cl_filter_custom.log_server_interface,  to logServer.log_server_interface);


        // seL4Notification
        connection  seL4Notification    conn_dataAvailable_logServer2logFileReader_finish( from logServer.logServer_finish, to logFileReader.logServer_finish);

        // seL4SharedData
        connection  seL4SharedData      conn_dataConnection_app_lvl_none(   from app_lvl_none.logServer_port,    to logServer.buf_lvl_none_port);
        connection  seL4SharedData      conn_dataConnection_app_lvl_assert( from app_lvl_assert.logServer_port,  to logServer.buf_lvl_assert_port);
        connection  seL4SharedData      conn_dataConnection_app_lvl_fatal(  from app_lvl_fatal.logServer_port,   to logServer.buf_lvl_fatal_port);
        connection  seL4SharedData      conn_dataConnection_app_lvl_error(  from app_lvl_error.logServer_port,   to logServer.buf_lvl_error_port);
        connection  seL4SharedData      conn_dataConnection_app_lvl_warning(from app_lvl_warning.logServer_port, to logServer.buf_lvl_warning_port);
        connection  seL4SharedData      conn_dataConnection_app_lvl_info(   from app_lvl_info.logServer_port,    to logServer.buf_lvl_info_port);
        connection  seL4SharedData      conn_dataConnection_app_lvl_debug(  from app_lvl_debug.logServer_port,   to logServer.buf_lvl_debug_port);
        connection  seL4SharedData      conn_dataConnection_app_lvl_trace(  from app_lvl_trace.logServer_port,   to logServer.buf_lvl_trace_port);
        connection  seL4SharedData      conn_dataConnection_app_lvl_custom( from app_lvl_custom.logServer_port,  to logServer.buf_lvl_custom_port);
        connection  seL4SharedData      conn_dataConnection_app_lvl_max(    from app_lvl_max.logServer_port,     to logServer.buf_lvl_max_port);

        connection  seL4SharedData      conn_dataConnection_app_no_filters( from app_no_filters.logServer_port,  to logServer.buf_no_filters_port);

        connection  seL4SharedData      conn_dataConnection_app_cl_filter_none(   from app_cl_filter_none.logServer_port,    to logServer.buf_cl_filter_none_port);
        connection  seL4SharedData      conn_dataConnection_app_cl_filter_assert( from app_cl_filter_assert.logServer_port,  to logServer.buf_cl_filter_assert_port);
        connection  seL4SharedData      conn_dataConnection_app_cl_filter_fatal(  from app_cl_filter_fatal.logServer_port,   to logServer.buf_cl_filter_fatal_port);
        connection  seL4SharedData      conn_dataConnection_app_cl_filter_error(  from app_cl_filter_error.logServer_port,   to logServer.buf_cl_filter_error_port);
        connection  seL4SharedData      conn_dataConnection_app_cl_filter_warning(from app_cl_filter_warning.logServer_port, to logServer.buf_cl_filter_warning_port);
        connection  seL4SharedData      conn_dataConnection_app_cl_filter_info(   from app_cl_filter_info.logServer_port,    to logServer.buf_cl_filter_info_port);
        connection  seL4SharedData      conn_dataConnection_app_cl_filter_debug(  from app_cl_filter_debug.logServer_port,   to logServer.buf_cl_filter_debug_port);
        connection  seL4SharedData      conn_dataConnection_app_cl_filter_trace(  from app_cl_filter_trace.logServer_port,   to logServer.buf_cl_filter_trace_port);
        connection  seL4SharedData      conn_dataConnection_app_cl_filter_custom( from app_cl_filter_custom.logServer_port,  to logServer.buf_cl_filter_custom_port);

        connection  seL4SharedData      conn_dataConnection_logFileReader(from logFileReader.logServer_port, to logServer.buf_logFileReader_port);
        connection  seL4SharedData      conn_dataConnection_fileReaderWriter(from fileReaderWriter.logServer_port, to logServer.buf_fileReaderWriter_port);
    }
    configuration {
        TimeServer_CLIENT_ASSIGN_BADGES(
            logServer.timeServer_rpc
        )

        app_lvl_none.log_server_interface_attributes          = 10;
        app_lvl_assert.log_server_interface_attributes        = 200;
        app_lvl_fatal.log_server_interface_attributes         = 3000;
        app_lvl_error.log_server_interface_attributes         = 40000;
        app_lvl_warning.log_server_interface_attributes       = 500000;
        app_lvl_info.log_server_interface_attributes          = 6000000;
        app_lvl_debug.log_server_interface_attributes         = 0xFFFF - 1;
        app_lvl_trace.log_server_interface_attributes         = 0xFFFF;
        app_lvl_custom.log_server_interface_attributes        = 0xFFFFFFF - 1;
        app_lvl_max.log_server_interface_attributes           = 0xAAAA;

        app_no_filters.log_server_interface_attributes        = 0xCAFE;

        app_cl_filter_none.log_server_interface_attributes    = 0xCAFE + 1;
        app_cl_filter_assert.log_server_interface_attributes  = 0xCAFE + 2;
        app_cl_filter_fatal.log_server_interface_attributes   = 0xCAFE + 3;
        app_cl_filter_error.log_server_interface_attributes   = 0xCAFE + 4;
        app_cl_filter_warning.log_server_interface_attributes = 0xCAFE + 5;
        app_cl_filter_info.log_server_interface_attributes    = 0xCAFE + 6;
        app_cl_filter_debug.log_server_interface_attributes   = 0xCAFE + 7;
        app_cl_filter_trace.log_server_interface_attributes   = 0xCAFE + 8;
        app_cl_filter_custom.log_server_interface_attributes  = 0xCAFE + 9;

        chanMux.log_server_interface_attributes               = 3001;

        app_lvl_none.log_lvl    = -1;
        app_lvl_assert.log_lvl  = -1;
        app_lvl_fatal.log_lvl   = -1;
        app_lvl_error.log_lvl   = -1;
        app_lvl_warning.log_lvl = -1;
        app_lvl_info.log_lvl    = -1;
        app_lvl_debug.log_lvl   = -1;
        app_lvl_trace.log_lvl   = -1;
        app_lvl_custom.log_lvl  = -1;
        app_lvl_max.log_lvl     = -1;

        app_no_filters.log_lvl  = -1;

        app_cl_filter_none.log_lvl    = 0;
        app_cl_filter_assert.log_lvl  = 1;
        app_cl_filter_fatal.log_lvl   = 2;
        app_cl_filter_error.log_lvl   = 3;
        app_cl_filter_warning.log_lvl = 4;
        app_cl_filter_info.log_lvl    = 5;
        app_cl_filter_debug.log_lvl   = 6;
        app_cl_filter_trace.log_lvl   = 7;
        app_cl_filter_custom.log_lvl  = 9;

        chanMux.log_lvl = 1;

        logFileReader.log_server_interface_attributes    = 50001;
        fileReaderWriter.log_server_interface_attributes = 50002;

        ramDisk.storage_size = (1 * 1024 * 1024);
        ramDisk_frw.storage_size = (1 * 1024 * 1024);
    }
}
